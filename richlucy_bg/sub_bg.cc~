void Richlucy(const double* const rho_arr, int nph,
              const double* const data_arr,
              const double* const resp_mat_arr,
              int nem, double tol_em,
              double tol_diff_l_var,
              int flag_line_search,
              string outdir, string outfile_head,
              int ndet, int nskyx, int nskyy, double epsilon,
              int bitpix, double* const out_arr)
{
    char outfile_moni[kLineSize];
    char qdpfile_timelog[kLineSize];
    char qdpfile_delta_logl[kLineSize];
    char qdpfile_kldiv[kLineSize];
    char qdpfile_diff_l_var[kLineSize];
    
    sprintf(outfile_moni, "%s/%s_moni.dat",
            outdir.c_str(), outfile_head.c_str());
    sprintf(qdpfile_timelog, "%s/%s_time_logl.qdp",
            outdir.c_str(), outfile_head.c_str());
    sprintf(qdpfile_delta_logl, "%s/%s_delta_logl.qdp",
            outdir.c_str(), outfile_head.c_str());
    sprintf(qdpfile_kldiv, "%s/%s_kldiv.qdp",
            outdir.c_str(), outfile_head.c_str());
    sprintf(qdpfile_diff_l_var, "%s/%s_diff_l_var.qdp",
            outdir.c_str(), outfile_head.c_str());        
    
    FILE* fp_moni = fopen(outfile_moni, "w");
    FILE* fp_timelog = fopen(qdpfile_timelog, "w");
    FILE* fp_delta_logl = fopen(qdpfile_delta_logl, "w");
    FILE* fp_kldiv = fopen(qdpfile_kldiv, "w");
    FILE* fp_diff_l_var = fopen(qdpfile_diff_l_var, "w");
    setbuf(fp_moni, NULL);
    setbuf(fp_timelog, NULL);
    setbuf(fp_delta_logl, NULL);
    setbuf(fp_kldiv, NULL);
    setbuf(fp_diff_l_var, NULL);    
    
    fprintf(fp_moni, "# iem, nzero, kldiv, helldist, logl, logl.inc, delta.logl, tdiff, lconst, diff_l_var\n");
    fprintf(fp_timelog, "# tdiff logl.inc\n");
    fprintf(fp_delta_logl, "skip sing\n");
    fprintf(fp_kldiv, "skip sing\n");
    fprintf(fp_diff_l_var, "skip sing\n");        
    
    double time_st = MiTime::GetTimeSec();
    double logl_init = GetFuncL(rho_arr, data_arr, resp_mat_arr,
                                ndet, nskyx, nskyy, epsilon);
    
    int nsky = nskyx * nskyy;
    double* rho_new_arr = new double[nsky];
    double* rho_pre_arr = new double[nsky];
    dcopy_(nsky, const_cast<double*>(rho_arr), 1, rho_new_arr, 1);
    dcopy_(nsky, const_cast<double*>(rho_arr), 1, rho_pre_arr, 1);


    for(int iem = 0; iem < nem; iem ++){
        double* mval_arr = new double[nsky];
        GetNextRhoArr(rho_new_arr, data_arr, resp_mat_arr, ndet, nsky, mval_arr);
        dcopy_(nsky, mval_arr, 1, rho_new_arr, 1);

        double kldiv    = GetKLDiv(rho_pre_arr, rho_new_arr, resp_mat_arr, ndet, nsky);
        double logl_pre = GetFuncL(rho_pre_arr, data_arr, resp_mat_arr,
                                   ndet, nskyx, nskyy, epsilon);
        double logl     = GetFuncL(rho_new_arr, data_arr, resp_mat_arr,
                                   ndet, nskyx, nskyy, epsilon);
        
        double delta_logl = logl - logl_pre;
        double logl_inc   = logl - logl_init;
        double time = MiTime::GetTimeSec();
        double tdiff = time - time_st;
        printf("iem = %d  kldiv = %e  logl = %.10e  logl - logl_init = %e "
               "delta_logl = %e  tdiff = %e \n",
               iem, kldiv, logl, logl_inc, delta_logl, tdiff);
        fprintf(fp_moni, "%d  %e  %.10e  %e  %e  %e  \n",
                iem, kldiv, logl, logl_inc, delta_logl, tdiff);
        fprintf(fp_timelog, "%e  %e\n", tdiff, logl_inc);
        fprintf(fp_delta_logl, "%d  %e\n", iem, delta_logl);
        fprintf(fp_kldiv, "%d  %e\n", iem, kldiv);

        if(kldiv < tol_em){
            printf("kldiv (%e) < tol_em (%e)\n", kldiv, tol_em);
            dcopy_(nsky, rho_new_arr, 1, out_arr, 1);

            char outfile_last_head[kLineSize];
            sprintf(outfile_last_head, "%s/%s_last_head.dat",
                    outdir.c_str(), outfile_head.c_str());
            FILE* fp_last_head = fopen(outfile_last_head, "w");
            fprintf(fp_last_head, "# mu  beta  iem  nzero  kldiv  helldist logl  logl_inc  delta_logl  tdiff  lconst  diff_l_var\n");
            fclose(fp_last_head);
            
            // last
            char outfile_last[kLineSize];
            sprintf(outfile_last, "%s/%s_last.dat",
                    outdir.c_str(), outfile_head.c_str());
            FILE* fp_last = fopen(outfile_last, "w");
            fprintf(fp_last, "%d  %e  %.10e  %e  %e  %e\n",
                    iem, kldiv, logl, logl_inc, delta_logl, tdiff);
            fclose(fp_last);
            break;
        }
        
        // for next
        dcopy_(nsky, rho_new_arr, 1, rho_pre_arr, 1);
        dcopy_(nsky, rho_new_arr, 1, out_arr, 1);

        delete [] mval_arr;
    }

    fclose(fp_moni);
    fclose(fp_timelog);
    fclose(fp_delta_logl);
    fclose(fp_kldiv);
    fclose(fp_diff_l_var);
    delete [] rho_new_arr;
    delete [] rho_pre_arr;
}
